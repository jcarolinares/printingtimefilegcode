#!/usr/bin/python

'''This python program takes a gcode generated by Cura and renames the file with the format: xxHxxM

Made by Julian Caro Linares, jcarolinares@gmail.com

'''

import os
import re
import sys

route="."


#Terminal parameter
if __name__ == '__main__':
    if len(sys.argv) != 2 or len(sys.argv) == 0:
        route="."
    else:
        route = sys.argv[1]
    #print route


#route= raw_input("Selecciona directorio a renombrar:\n")
route=str(route)

files_list=os.listdir(route)

#for x in files_list:
#    print x

for gcode_file in files_list:
    if re.search('.gcode',gcode_file):
        #print (route+gcode_file)

        #Reading the file
        if route==".":
            file=open(gcode_file,'a+')
        else:
            file=open(route+gcode_file,'a+')


        file_string=file.read()
        if not re.search('; -- renamed with printing_time_file.py',file_string): #If file hasn't been renamed before
            file.write("\n; -- renamed with printing_time_file.py - More info in https://github.com/jcarolinares/printingtimefilegcode")
        file.close()

        if not re.search('; -- renamed with printing_time_file.py',file_string): #If file hasn't been renamed before

            string_time=re.search(';Print time: (.+?)minutes',file_string)

            if string_time:
                file_string= string_time.group()

            #print (file_string)

            file_string=file_string.replace(';Print time: ','')
            file_string=file_string.replace(' hour ','h')
            file_string=file_string.replace(' hours ','h')
            file_string=file_string.replace(' minutes','m')
            file_string=file_string.replace(' minute','m')

            #print (file_string)

            new_file_name=file_string+'-'+gcode_file

            #print (new_file_name)

            #Time to rename the file
            if route==".":
                os.rename(gcode_file, gcode_file.replace(gcode_file, new_file_name))
            else:
                os.rename(route+gcode_file, route+gcode_file.replace(gcode_file, new_file_name))
